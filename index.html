<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paragraph Assessment Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans Thai', sans-serif; }
        .progress-ring__circle { transition: stroke-dashoffset 0.35s; transform: rotate(-90deg); transform-origin: 50% 50%; }
        #assess-button #button-spinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen p-4">
    <div class="w-full max-w-4xl mx-auto my-8">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-8">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-6">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Paragraph Assessment</h1>
                        <p class="text-gray-500 dark:text-gray-400 mt-1">Cause & Effect Rubric (Max Score: 20)</p>
                    </div>
                    <div class="flex items-center gap-2 px-3 py-1.5 bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300 rounded-full text-sm font-medium">
                        <span>Powered by Gemini 2.5</span>
                    </div>
                </div>

                <div class="mb-6">
                    <label for="topic-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Assignment Topic (หัวข้องานเขียน)</label>
                    <input type="text" id="topic-input" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-purple-500 dark:bg-gray-700 dark:text-white" placeholder="e.g., The Effects of Inflation on Personal Savings">
                </div>

                <div class="mb-6">
                    <label for="student-essay" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Student's Paragraph</label>
                    <div class="relative">
                        <textarea id="student-essay" rows="8" class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-purple-500 dark:bg-gray-700 dark:text-gray-200" placeholder="Paste the paragraph here..."></textarea>
                        <div id="word-count" class="absolute bottom-3 right-3 text-sm text-gray-400">0 words</div>
                    </div>
                </div>

                <div class="text-center">
                    <button id="assess-button" class="relative w-full md:w-auto bg-purple-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-purple-700 transition-all disabled:opacity-50 flex items-center justify-center mx-auto">
                        <span id="button-text">Assess Paragraph</span>
                        <svg id="button-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>
            </div>
            
            <div id="results-section" class="bg-white dark:bg-gray-800/50 p-8 border-t border-gray-200 dark:border-gray-700 hidden">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Assessment Results</h2>
                <div id="error-message" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-6"><p id="error-text"></p></div>
                
                <div id="results-content" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-sm">
                            <span class="font-medium text-gray-600 dark:text-gray-300">1. Format & Content</span>
                            <span id="score-format" class="font-bold text-lg text-purple-600 dark:text-purple-400">-/5</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-sm">
                            <span class="font-medium text-gray-600 dark:text-gray-300">2. Organization</span>
                            <span id="score-org" class="font-bold text-lg text-purple-600 dark:text-purple-400">-/5</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-sm">
                            <span class="font-medium text-gray-600 dark:text-gray-300">3. Grammar</span>
                            <span id="score-grammar" class="font-bold text-lg text-purple-600 dark:text-purple-400">-/5</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-sm">
                            <span class="font-medium text-gray-600 dark:text-gray-300">4. Vocabulary</span>
                            <span id="score-vocab" class="font-bold text-lg text-purple-600 dark:text-purple-400">-/5</span>
                        </div>
                    </div>

                    <div class="flex flex-col gap-6">
                        <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg shadow-sm text-center flex flex-col items-center justify-center h-full">
                            <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Total Score</h3>
                            <div class="relative w-40 h-40 mt-4">
                                <svg class="w-full h-full" viewBox="0 0 36 36">
                                    <path class="text-gray-200 dark:text-gray-600" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3" />
                                    <path id="score-ring" class="text-purple-600 dark:text-purple-400 progress-ring__circle" stroke-width="3" fill="none" stroke-linecap="round" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" stroke-dasharray="100, 100" stroke-dashoffset="100" />
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center flex-col">
                                    <span id="total-score" class="text-5xl font-bold text-gray-800 dark:text-white">--</span>
                                    <span class="text-sm text-gray-500 dark:text-gray-400">/ 20</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="md:col-span-2 bg-gray-50 dark:bg-gray-700 p-6 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Areas for Improvement</h3>
                            <button id="rewrite-button" class="hidden bg-purple-100 text-purple-700 text-sm font-semibold py-2 px-4 rounded-lg hover:bg-purple-200 flex items-center gap-2">
                                <span id="rewrite-button-text">✨ Rewrite with AI</span>
                                <svg id="rewrite-spinner" class="animate-spin h-4 w-4 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            </button>
                        </div>
                        <div id="feedback" class="text-gray-600 dark:text-gray-300 space-y-2"><p>Feedback will appear here...</p></div>
                        <div id="rewrite-section" class="mt-6 border-t border-gray-200 dark:border-gray-600 pt-4 hidden">
                            <h4 class="text-md font-semibold text-gray-800 dark:text-white mb-2">✨ AI-Suggested Rewrite</h4>
                            <div id="rewritten-text" class="p-4 bg-white dark:bg-gray-900/20 rounded-md text-gray-600 dark:text-gray-300 whitespace-pre-wrap font-serif"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // Elements
    const topicInput = document.getElementById('topic-input');
    const studentEssay = document.getElementById('student-essay');
    const assessButton = document.getElementById('assess-button');
    const resultsSection = document.getElementById('results-section');
    const wordCountEl = document.getElementById('word-count');
    
    // Scores
    const scoreFormat = document.getElementById('score-format');
    const scoreOrg = document.getElementById('score-org');
    const scoreGrammar = document.getElementById('score-grammar');
    const scoreVocab = document.getElementById('score-vocab');
    const totalScoreEl = document.getElementById('total-score');
    
    // Feedback & Rewrite
    const feedbackEl = document.getElementById('feedback');
    const rewriteButton = document.getElementById('rewrite-button');
    const rewriteSection = document.getElementById('rewrite-section');
    const rewrittenText = document.getElementById('rewritten-text');
    let currentFeedbackText = "";

    // Ring Graph
    const scoreRing = document.getElementById('score-ring');
    const circumference = scoreRing.getTotalLength();
    scoreRing.style.strokeDasharray = `${circumference} ${circumference}`;
    scoreRing.style.strokeDashoffset = circumference;

    function setProgress(percent) {
        const offset = circumference - (percent / 100) * circumference;
        scoreRing.style.strokeDashoffset = offset;
    }

    studentEssay.addEventListener('input', () => {
        const count = studentEssay.value.trim().split(/\s+/).filter(Boolean).length;
        wordCountEl.textContent = `${count} words`;
    });

    assessButton.addEventListener('click', () => callCloudFunction('assess'));
    rewriteButton.addEventListener('click', () => callCloudFunction('rewrite'));

    async function callCloudFunction(action) {
        const essayText = studentEssay.value;
        const topic = topicInput.value; // ดึงค่าหัวข้อ

        if (!essayText.trim()) { alert("Please enter the paragraph text."); return; }
        
        // UI Loading State
        const isRewrite = action === 'rewrite';
        const btnText = isRewrite ? document.getElementById('rewrite-button-text') : document.getElementById('button-text');
        const btnSpinner = isRewrite ? document.getElementById('rewrite-spinner') : document.getElementById('button-spinner');
        
        if(isRewrite) rewriteButton.disabled = true;
        else assessButton.disabled = true;
        
        btnText.classList.add('hidden');
        btnSpinner.classList.remove('hidden');
        if(!isRewrite) {
            resultsSection.classList.add('hidden'); 
            document.getElementById('error-message').classList.add('hidden');
        }

        try {
            const CLOUD_FUNCTION_URL = 'https://assessessay-761741684216.asia-southeast1.run.app';
            
            const response = await fetch(CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    essayText, 
                    topic, // ส่ง topic ไปด้วย
                    action, 
                    feedbackForRewrite: currentFeedbackText 
                }),
            });

            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();

            if (isRewrite) {
                rewrittenText.textContent = data.rewrittenText;
                rewriteSection.classList.remove('hidden');
            } else {
                displayResults(data);
            }
        } catch (error) {
            console.error(error);
            const errDiv = document.getElementById('error-message');
            errDiv.classList.remove('hidden');
            document.getElementById('error-text').textContent = "An error occurred. Please try again.";
            resultsSection.classList.remove('hidden');
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        } finally {
            if(isRewrite) rewriteButton.disabled = false;
            else assessButton.disabled = false;
            btnText.classList.remove('hidden');
            btnSpinner.classList.add('hidden');
        }
    }

    function displayResults(data) {
        resultsSection.classList.remove('hidden');
        resultsSection.scrollIntoView({ behavior: 'smooth' });

        // Map Data to UI (New Rubric)
        const s1 = data.formatScore || 0;
        const s2 = data.organizationScore || 0;
        const s3 = data.grammarScore || 0;
        const s4 = data.vocabularyScore || 0;
        const total = s1 + s2 + s3 + s4;

        scoreFormat.textContent = `${s1}/5`;
        scoreOrg.textContent = `${s2}/5`;
        scoreGrammar.textContent = `${s3}/5`;
        scoreVocab.textContent = `${s4}/5`;
        totalScoreEl.textContent = total;

        // Calculate Ring (Max 20)
        setProgress((total / 20) * 100);

        // Feedback
        currentFeedbackText = data.feedback;
        const listItems = data.feedback.split('*').filter(i => i.trim()).map(i => `<li class="ml-4 list-disc">${i.trim()}</li>`).join('');
        feedbackEl.innerHTML = `<ul>${listItems}</ul>`;
        rewriteButton.classList.remove('hidden');
    }
</script>
</body>
</html>
